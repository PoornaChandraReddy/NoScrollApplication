<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NoScroll App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />
</head>

<body class="font-inter bg-gradient-to-br from-blue-100 to-blue-200 min-h-screen flex items-center justify-center">

  <div id="setup-card" class="card bg-white p-6 rounded-xl shadow-lg max-w-md w-full hidden">
    <form id="setupForm">
      <h2 class="text-xl font-semibold mb-4">Set up your profile</h2>

      <label class="block mb-2">Customer Name</label>
      <input type="text" name="customerName" class="form-input" required>

      <label class="block mt-3 mb-2">Email</label>
      <input type="email" name="email" class="form-input" required>

      <label class="block mt-3 mb-2">Age</label>
      <input type="number" name="age" class="form-input" required>

      <label class="block mt-3 mb-2">User Type:</label>
      <div>
        <input type="radio" name="userType" value="Individual" checked> Individual
        <input type="radio" name="userType" value="Parent"> Parent
      </div>

      <div id="parentFields" class="hidden mt-3">
        <label class="block mb-2">Child Name</label>
        <input type="text" name="childName" class="form-input">
        <label class="block mb-2 mt-3">Child Email</label>
        <input type="text" name="childEmail" class="form-input">
      </div>

      <button type="submit" class="mt-4 bg-blue-600 text-white py-2 px-4 rounded">Save & Continue</button>
    </form>
  </div>

  <div id="time-limit-card" class="card hidden">
    <h2>Session Setup</h2>
    <button id="start-session-btn" class="bg-green-600 text-white mt-4 py-2 px-4 rounded">Start Session</button>
  </div>

  <!-- Loading overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
    <span class="text-white text-lg">Loading...</span>
  </div>

  <script type="module">
    const API_BASE_URL = "https://yoursalesforceapi.com";
    const parentFieldsDiv = document.getElementById("parentFields");
    const setupForm = document.getElementById("setupForm");
    const loadingOverlay = document.getElementById("loadingOverlay");
    const startSessionBtn = document.getElementById("start-session-btn");
    const userTypeRadios = document.querySelectorAll('input[name="userType"]');

    async function waitForCapacitorReady() {
      return new Promise(resolve => {
        if (window.Capacitor?.isPluginAvailable) resolve();
        else {
          const check = setInterval(() => {
            if (window.Capacitor?.Plugins) {
              clearInterval(check);
              resolve();
            }
          }, 200);
        }
      });
    }

    function showAlert(msg, type) {
      alert(msg);
      console.log(type + ": " + msg);
    }

    function showPage(id) {
      document.querySelectorAll(".card").forEach(c => c.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    }

    async function startSessionHandler() {
      console.log("Start session handler triggered");
      localStorage.setItem("sessionActive", "true");
      showAlert("üöÄ Session started successfully!", "success");
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await waitForCapacitorReady();
      console.log("Capacitor ready & DOM loaded");

      const { LocalNotifications, AppLauncher } = window.Capacitor?.Plugins || {};
      window.LocalNotifications = LocalNotifications;
      window.AppLauncher = AppLauncher;

      // Setup form logic
      userTypeRadios.forEach(radio => {
        radio.addEventListener('change', (event) => {
          if (event.target.value === 'Parent') {
            parentFieldsDiv.classList.remove('hidden');
          } else {
            parentFieldsDiv.classList.add('hidden');
          }
        });
      });

      setupForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        loadingOverlay.classList.remove("hidden");
        const formData = new FormData(setupForm);
        const payload = {
          action: "setup",
          customerName: formData.get("customerName"),
          email: formData.get("email"),
          age: parseInt(formData.get("age")),
          userType: formData.get("userType"),
        };
        if (payload.userType === "Parent") {
          payload.childName = formData.get("childName");
          payload.childEmail = formData.get("childEmail");
        }

        try {
          const res = await fetch(API_BASE_URL + "/api/log-usage", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const result = await res.json();
          if (res.ok && result.status === "success") {
            const newCustomerId = result.salesforce_response.customerId;
            const userEmail = result.salesforce_response.email;
            localStorage.setItem("customerId", newCustomerId);
            localStorage.setItem("email", userEmail);
            showAlert("‚úÖ Profile created successfully!", "success");
            setTimeout(() => showPage("time-limit-card"), 500);
          } else {
            showAlert(`‚ùå ${result.message || "Something went wrong"}`, "error");
          }
        } catch (err) {
          showAlert("‚ùå Network or server error", "error");
          console.error(err);
        } finally {
          loadingOverlay.classList.add("hidden");
        }
      });

      // Bind Start Session button once Capacitor ready
      if (startSessionBtn) {
        startSessionBtn.addEventListener("click", startSessionHandler);
      }

      // Default page selection on load
      const existingCustomer = localStorage.getItem("customerId");
      if (existingCustomer) showPage("time-limit-card");
      else showPage("setup-card");
    });
  </script>
</body>
</html>
